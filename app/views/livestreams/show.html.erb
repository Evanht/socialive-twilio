
<div class="container" id="title-controls-container" style="background: linear-gradient(-225deg, rgba(255, 255, 255, 0.68) 0%, rgba(255, 255, 255, 1) 80%), url(<%= cl_image_path @livestream.main_picture.path %>);">

  <div id="background-image-title-banner">

  </div>

  <div class="row">
    <div class="col-xs-8 col-sm-8">

      <h2 style="color: #000030;", id="livestream-show-page-title"><%= @livestream.user.first_name.capitalize %> <%= @livestream.user.last_name.capitalize %></h2><h4 id="livestream-show-page-title"><%= @livestream.title %></h4>

    </div>
    <div class="col-xs-4 col-sm-4">
      <% if current_user == @livestream.user && @livestream.hour_of_stream <= Time.now %>
      <div id="controls">

        <div id="preview">

          <!-- <div id="local-media"></div> -->

          <button class="btn-primary btn btn-float-left hidden-buttons" id="button-preview">Preview My Camera</button>

        </div>
        <div id="room-controls">
          <!-- <p class="instructions">Room Name:</p> -->
          <!-- <input id="room-name" type="text-area" placeholder="Enter a room name" /> -->
          <%#= if current_user == @livestream.user %>
          <button class="btn-primary btn btn-float-left" id="button-join">Start stream</button>

          <button class="btn-primary btn btn-float-left" id="button-leave">End stream</button>

        </div>
        <div id="log">
        </div>
      </div>
      <% elsif current_user == @livestream.user  %>
      <em>Refresh this page when your livestream is scheduled to start and a "Start stream" button will appear </em>
      <div id="controls">

        <div id="preview">

          <!-- <div id="local-media"></div> -->

          <button class="btn-primary btn btn-float-left" id="button-preview">Preview My Camera</button>

        </div>
        <div id="room-controls">
          <!-- <p class="instructions">Room Name:</p> -->
          <!-- <input id="room-name" type="text-area" placeholder="Enter a room name" /> -->
          <%#= if current_user == @livestream.user %>
          <button class="btn-primary btn btn-float-left hidden-buttons" id="button-join">Start stream</button>

          <button class="btn-primary btn btn-float-left hidden-buttons" id="button-leave">End stream</button>

        </div>
        <div id="log"></div>
      </div>
      <% elsif current_user.tickets.where(livestream: @livestream).any? %>
      <p id="ticket-bought">Ticket Bought</p>
      <div class="hidden-buttons">
        <div id="controls">

          <div id="preview">

            <div id="local-media"></div>

            <button id="button-preview">Preview My Camera</button>

          </div>
          <div id="room-controls">
            <!-- <p class="instructions">Room Name:</p> -->
            <!-- <input id="room-name" type="text-area" placeholder="Enter a room name" /> -->
            <%#= if current_user == @livestream.user %>
            <button id="button-join">Join Room</button>

            <button id="button-leave">Leave Room</button>

          </div>
          <div id="log"></div>
        </div>
      </div>
      <% elsif (@livestream.tickets_available - @livestream.tickets_sold) > 0 %>
      <%= render 'shared/buy_ticket' %>
      <% else %>
         <p id="tickets-sold-out">Sold out</p>
      <% end %>
    </div>
  </div>
</div>

<div class="mid-screen-wrapper">

  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-7">
        <!-- This is the video div BELOW -->
        <div id="remote-media" class="video-container">
          <div id="local-media"></div>


          <% content_for :after_js do %>
          <script src="//media.twiliocdn.com/sdk/js/video/v1/twilio-video.min.js"></script>
          <% end %>
          <% content_for :after_js do %>
           <script>// Check for WebRTC
            var videoClient;
            var activeRoom;
            var previewMedia;
            var identity;
            var roomName;

            if (!navigator.webkitGetUserMedia && !navigator.mozGetUserMedia) {
              alert('Socialive only supports chrome & firefox');
            }

              // $.getJSON('/token', function () {
                identity = '<%= current_user.first_name %>';

                // Create a Video Client and connect to Twilio
                videoClient = new Twilio.Video.Client('<%= generate_twilio_token %>');
                document.getElementById('room-controls').style.display = 'block';


                <% if current_user != @livestream.user %>
                // Bind button to join room
                // document.getElementById('button-join').onclick = function () {
                  // roomName = document.getElementById('room-name').value;
                  roomName = '<%= @livestream.room_name %>'

                  if (roomName) {
                    // log("Joining room '" + roomName + "'...");

                    videoClient.connect({ to: roomName, video: false, audio: false}).then(roomJoined,
                      function(error) {
                        log('Could not connect to Twilio: ' + error.message);
                      });
                  } else {
                    alert('<%= @livestream.room_name %>');
                  }
                // };
                <% else %>
                  // Bind button to join room
                  document.getElementById('button-join').onclick = function () {
                    // roomName = document.getElementById('room-name').value;
                    roomName = '<%= @livestream.room_name %>'

                    if (roomName) {
                      // log("Joining room '" + roomName + "'...");

                      videoClient.connect({ to: roomName}).then(roomJoined,
                        function(error) {
                          log('Could not connect to Twilio: ' + error.message);
                        });
                    } else {
                      alert('No Twilio room_name for livestream');
                    }
                  };

                   // Bind button to leave room
                   document.getElementById('button-leave').onclick = function () {
                    log('Leaving room...');
                    activeRoom.disconnect();
                  };
              // });
              <% end  %>




              // Successfully connected!
              function roomJoined(room) {
                activeRoom = room;

                // log("Joined as '" + identity + "'");
                document.getElementById('button-join').style.display = 'none';
                document.getElementById('button-leave').style.display = 'inline';

                // Draw local video, if not already previewing
                if (!previewMedia) {
                  room.localParticipant.media.attach('#local-media');
                }

                room.participants.forEach(function(participant) {
                  log("Already in Room: '" + participant.identity + "'");
                  participant.media.attach('#remote-media');
                });

                // When a participant joins, draw their video on screen
                room.on('participantConnected', function (participant) {
                  log("Joining: '" + participant.identity + "'");
                  participant.media.attach('#remote-media');
                });

                // When a participant disconnects, note in log
                room.on('participantDisconnected', function (participant) {
                  log("Participant '" + participant.identity + "' left the room");
                  participant.media.detach();
                });

                // When we are disconnected, stop capturing local video
                // Also remove media for all remote participants
                room.on('disconnected', function () {
                  log('Left');
                  room.localParticipant.media.detach();
                  room.participants.forEach(function(participant) {
                    participant.media.detach();
                  });
                  activeRoom = null;
                  document.getElementById('button-join').style.display = 'inline';
                  document.getElementById('button-leave').style.display = 'none';
                });
              }

              //  Local video preview
              document.getElementById('button-preview').onclick = function () {
                if (!previewMedia) {
                  previewMedia = new Twilio.Video.LocalMedia();
                  Twilio.Video.getUserMedia().then(
                    function (mediaStream) {
                      previewMedia.addStream(mediaStream);
                      previewMedia.attach('#local-media');
                    },
                    function (error) {
                      console.error('Unable to access local media', error);
                      log('Unable to access Camera and Microphone');
                    });
                };
              };

              // Activity log
              function log(message) {
                var logDiv = document.getElementById('log');
                logDiv.innerHTML += '<p>&gt;&nbsp;' + message + '</p>';
                logDiv.scrollTop = logDiv.scrollHeight;
              }

              function leaveRoomIfJoined() {
                if (activeRoom) {
                  activeRoom.disconnect();
                }
              }

              $('#message_body').keypress(function(e){
                if(e.which == 13){
                 $(this).closest('form').submit();
               }
             });

           </script>
           <% end %>
         </div>

         <!-- Bit hacky but am going to display to different vesrions of the controls and the viewers ones will have ids that display: none -->

         <!-- This is the video div ABOVE -->
       </div>

       <div class="col-xs-12 col-sm-5">
        <div class="chat-container">
          <!-- THIS IS THE CHAT below -->

          <div id="messages" data-chat-room-id="<%= @livestream.id %>">
            <%= render @livestream.messages %>
          </div>
        </div>
        <%= form_for @message, url: '#' do |f| %>
        <div class="form-group">

          <%= f.text_area :body, class: 'form-control text-input-better-css' %>

        </div>

        <%= f.submit "send", class: 'btn btn-primary btn-sm send-message-btn' %>
        <% end %>
        <!-- THIS IS THE CHAT ^^^ -->

      </div>

    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-10 col-md-offset-1">
      <% if current_user == @livestream.user %>
      <h4>Questions asked by ticket holders before the livestream</h4>
      <!-- <div id="inquiry-input"> -->
      <%#= simple_form_for [@livestream, @question] do |f| %>
      <%#= f.input :inquiry, label: false %>
      <%#= f.button :submit, 'Ask', class: 'btn btn-primary' %>
      <%# end %>
      <!-- </div> -->
      <div class="pre-livestream-questions-container">
        <table id="pre-livestream-questions">
          <% if @livestream.questions.any? %>
          <% @livestream.questions.each do |question| %>
          <tr>
            <th><%= question.inquiry %></th>
            <td><%= question.user.first_name %></td>
          </tr>
          <% end %>
          <% end %>
        </table>
      </div>
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- this col is the profile -->
    <div class="col-xs-12 col-md-8">
      <div class="profile-wrapper margin-bottom-20">
        <!-- now we nest another bootstrap grid so that we can have a responsive profile layout -->
        <div class="row">
          <!-- Below is the avatar div -->
          <div class="col-xs-12 col-sm-4">
            <div>
              <% if @livestream.user.profilepic != nil %>
              <%= cl_image_tag(@livestream.user.profilepic.path, class: "profile-avatar-circle", crop: :fill) %>
              <% else  %>
              <% end %>
            </div>
          </div>
          <!-- Below is the about user div-->
          <div class="col-xs-12 col-sm-8">
            <h3><%= @livestream.user.first_name.capitalize %></h3>
          </div>

          <div class="col-xs-12 col-sm-8">
              <%= render 'shared/follow_form' %>
              <%= render 'shared/stats' %>
          </div>

          <div class="col-xs-12 col-sm-8">
            <% @user.livestreams.each do |livestream| %>
            <p> <%= livestream.tickets_sold %> Total views </p>
            <% end %>

          </div>

        <!-- this is the row for the bio -->
        <div class="row">
          <div class="col-xs-12">
            <div class="profile-about">
              <h3 style= "display: inline; box-sizing: border-box; box-shadow: inset 0px -10px 0px 0px #b7ffd4;">Bio</h3>
              <p><%= @livestream.user.bio %> </p>
            </div>
          </div>
        </div>

          <div class="col-xs-12 ">
            <h3 style= "display: inline; box-sizing: border-box; box-shadow: inset 0px -10px 0px 0px #b7ffd4;">Things I love</h3>
            <table summary="favourite things">
              <tr>
                <th><%= @livestream.user.fav1title %></th>
                <td class="profile-favourite-table-answer"> <%= @livestream.user.fav1 %></td>
              </tr>
              <tr>
                <th><%= @livestream.user.fav2title %></th>
                <td class="profile-favourite-table-answer"><%= @livestream.user.fav2 %></td>
              </tr>
              <tr>
                <th><%= @livestream.user.fav3title %></th>
                <td class="profile-favourite-table-answer"><%= @livestream.user.fav3 %></td>
              </tr>
            </table>
          </div>

        </div>

        <!-- this is the row for the picture gallery -->
        <div class="row">
          <div class="col-xs-12">
            <div class="black-photo-gallery-wrapper text-center">
              <% @livestream.user.images.each do |photo| %>
              <%= cl_image_tag photo.path, :width=>300 %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>






    <div class="col-xs-12 col-md-4 text-center">
      <br>
      <br>
      <h3 style= "display: inline; box-sizing: border-box; box-shadow: inset 0px -10px 0px 0px #b7ffd4;">Upcoming livestreams</h3>
      <!-- <div class="profile-wrapper">
        <p>Sonya's calendar</p>
      </div> -->
      <%#= image_tag "calendar.svg", :class => "small-calendar"%>
      <% @livestreams.each do |livestream| %>
      <div class="profile-wrapper margin-bottom-20">

        <!-- This is start of the card for an upcoming event -->
        <div class="future-livestreams-card">
          <!-- need to put logic here to truncate title if over 58 characters -->
          <h5 class="future-livestreams-card-title"><%= livestream.title.first(58) %></h5>
          <h6 class="future-livestreams-card-time"> <%= livestream.hour_of_stream.strftime('%A, %b %d %H:%M') %></h6>
          <h6 class="future-livestreams-card-seats"> <%= livestream.tickets_available - (livestream.tickets_sold || 0 )%> seats left </h6>
          <a href="" class="future-livestreams-card-book-button btn btn-primary">book ticket</a>
        </div>

        <!-- This is the end of the card for an upcoming event -->
      </div>
      <% end %>
    </div>

    <!-- This is the top fans table -->
    <div class="col-xs-12 col-md-4 text-center">
          <h3 style= "display: inline; box-sizing: border-box; box-shadow: inset 0px -10px 0px 0px #b7ffd4;">Top fans</h3>
      <div class="profile-wrapper">
        <div class="leaderboard">
          <ol class="leaderboard-list">
            <li>
              <mark>Jerry Wood</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 924</small>
            </li>
            <li>
              <mark>Brandon Barnes</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 919</small>
            </li>
            <li>
              <mark>Raymond Knight</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 750</small>
            </li>
            <li>
              <mark>Trevor McCormick</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 746</small>
            </li>
            <li>
              <mark>Andrew Fox</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 699</small>
            </li>
            <li>
              <mark>Jerry Wood</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 600</small>
            </li>
            <li>
              <mark>Brandon Barnes</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 420</small>
            </li>
            <li>
              <mark>Raymond Knight</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 418</small>
            </li>
            <li>
              <mark>Trevor McCormick</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 406</small>
            </li>
            <li>
              <mark>Andrew Fox</mark>
              <small> <span><img src="/assets/ruby-1c4db2d54622c936d213665e5137a5444b6b1528e6c9bdaf9994720fc5a0f7f4.svg" alt="Ruby" id="ruby_fans_img"></span> 386</small>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <!-- This is the social media follow div -->
    <div class="col-xs-12 col-md-4">
      <div class="profile-wrapper text-center margin-bottom-20">
        <h4> Follow <%= @livestream.user.first_name %> on . . .</h4>

        <i style="font-size: 100px; padding-right: 10px;" class="fa fa-facebook-square" aria-hidden="true"></i>
        <i style="font-size: 100px; padding-right: 10px;" class="fa fa-instagram" aria-hidden="true"></i>
        <i style="font-size: 100px; padding-right: 10px;" class="fa fa-snapchat-square" aria-hidden="true"></i>
      </div>

    </div>

  </div>
</div>
</div>


